
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mnc.common &#8212; mnc_python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mnc.common</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="kn">import</span> <span class="n">TimedRotatingFileHandler</span>

<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span> <span class="k">as</span> <span class="n">AstroTime</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FS&#39;</span><span class="p">,</span> <span class="s1">&#39;CLOCK&#39;</span><span class="p">,</span> <span class="s1">&#39;NCHAN&#39;</span><span class="p">,</span> <span class="s1">&#39;CHAN_BW&#39;</span><span class="p">,</span> <span class="s1">&#39;NPIPELINE&#39;</span><span class="p">,</span> <span class="s1">&#39;OVRO_EPOCH&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ETCD_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;ETCD_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;LWATime&#39;</span><span class="p">,</span> <span class="s1">&#39;chan_to_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_to_chan&#39;</span><span class="p">,</span>
           <span class="s1">&#39;quota_size&#39;</span><span class="p">,</span> <span class="s1">&#39;daemonize&#39;</span><span class="p">,</span> <span class="s1">&#39;LogFileHandler&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_signal_handling&#39;</span><span class="p">,</span>
           <span class="s1">&#39;synchronize_time&#39;</span><span class="p">]</span>


<span class="c1">#: Sample rate that is the basis for LWA time tags</span>
<span class="n">FS</span>               <span class="o">=</span> <span class="mf">196.0e6</span>

<span class="c1">#: Sample rate for the ADCs</span>
<span class="n">CLOCK</span>            <span class="o">=</span> <span class="mf">196.0e6</span>

<span class="c1">#: Total number of channels computed by the F-engine</span>
<span class="n">NCHAN</span>            <span class="o">=</span> <span class="mi">4096</span>

<span class="c1">#: Channel bandwidth coming out of the F-Engine</span>
<span class="n">CHAN_BW</span>          <span class="o">=</span> <span class="n">CLOCK</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">NCHAN</span><span class="p">)</span>

<span class="c1">#: Total number of GPU pipelines</span>
<span class="n">NPIPELINE</span>        <span class="o">=</span> <span class="mi">32</span>

<span class="c1">#: Epoch that is the basis for LWA time tags</span>
<span class="n">OVRO_EPOCH</span>       <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="c1">#: etcd hostname - can be overridden with a &#39;ETCD_HOST = ...&#39; line in &#39;etcd.cfg&#39; file</span>
<span class="n">ETCD_HOST</span> <span class="o">=</span> <span class="s1">&#39;etcdv3service&#39;</span>


<span class="c1">#: etcd port - can be overridden with a &#39;ETCD_PORT = ...&#39; line in &#39;etcd.cfg&#39; file</span>
<span class="n">ETCD_PORT</span> <span class="o">=</span> <span class="mi">2379</span>


<span class="c1"># Try the etcd.cfg file to see if we need to override either _HOST or _PORT</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;etcd.cfg&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;etcd.cfg&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ETCD_HOST&#39;</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">ETCD_HOST</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ETCD_PORT&#39;</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">ETCD_PORT</span> <span class="o">=</span> <span class="n">value</span>


<div class="viewcode-block" id="LWATime"><a class="viewcode-back" href="../../index.html#mnc.common.LWATime">[docs]</a><span class="k">class</span> <span class="nc">LWATime</span><span class="p">(</span><span class="n">AstroTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of :py:class:`astropy.time.Time` that accept a LWA timetag as an input.</span>
<span class="sd">    It also attributes for accessing a (seconds, fraction seconds) tuple (&quot;tuple&quot;)</span>
<span class="sd">    and a LWA timetag (&quot;timetag&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;timetag&#39;</span><span class="p">:</span>
            <span class="n">sec</span> <span class="o">=</span> <span class="n">val</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="n">FS</span><span class="p">)</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">FS</span><span class="p">))</span> <span class="o">/</span> <span class="n">FS</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">sec</span><span class="p">,</span> <span class="n">frac</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;unix&#39;</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;utc&#39;</span>
        <span class="n">AstroTime</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                           <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_subfmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">out_subfmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a (seconds, fractional seconds) tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timetag</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">val</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="n">FS</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">FS</span><span class="p">))</span> <span class="o">/</span> <span class="n">FS</span>
        <span class="k">return</span> <span class="n">sec</span><span class="p">,</span> <span class="n">frac</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timetag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a LWA timetag (ticks of a FS clock since the unix epoch).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">sec1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jd1</span> <span class="o">-</span> <span class="mf">2440587.5</span><span class="p">)</span><span class="o">*</span><span class="mi">86400</span>
        <span class="n">sec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jd2</span><span class="o">*</span><span class="mi">86400</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec2</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">sec1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sec2</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="n">FS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">frac</span><span class="o">*</span><span class="n">FS</span><span class="p">)</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">casa_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a two element tuple of (CASA time reference, CASA time string)</span>
<span class="sd">        that is suitable for use with casacore.measures.measures.epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">datetime</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple</span>
        <span class="n">casa_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">:</span><span class="si">%i</span><span class="s1">:</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                           <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="o">+</span><span class="n">frac</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;UTC&#39;</span><span class="p">,</span> <span class="n">casa_time</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurementset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a time value of MJD seconds that is compatible with how time is</span>
<span class="sd">        stored in a measurement set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">mjd</span><span class="o">*</span><span class="mf">86400.0</span></div>


<div class="viewcode-block" id="chan_to_freq"><a class="viewcode-back" href="../../index.html#mnc.common.chan_to_freq">[docs]</a><span class="k">def</span> <span class="nf">chan_to_freq</span><span class="p">(</span><span class="n">chan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a channel number to a frequency in Hz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">CHAN_BW</span><span class="o">*</span><span class="n">chan</span></div>


<div class="viewcode-block" id="freq_to_chan"><a class="viewcode-back" href="../../index.html#mnc.common.freq_to_chan">[docs]</a><span class="k">def</span> <span class="nf">freq_to_chan</span><span class="p">(</span><span class="n">freq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a frequency in Hz to a channel number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="n">CHAN_BW</span><span class="p">))</span></div>


<div class="viewcode-block" id="quota_size"><a class="viewcode-back" href="../../index.html#mnc.common.quota_size">[docs]</a><span class="k">def</span> <span class="nf">quota_size</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Covnert a human readable quota size into a number of bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">_UNITS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^\s*(?P&lt;value&gt;\d+(\.(\d*)?)?)\s*(?P&lt;scale&gt;[kMGTP]i?)?B?$&#39;</span><span class="p">)</span>
    <span class="n">_UNITS_SCALES</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s1">&#39;k&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>    <span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                     <span class="s1">&#39;M&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Mi&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                     <span class="s1">&#39;G&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Gi&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                     <span class="s1">&#39;T&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span>
                     <span class="s1">&#39;P&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Pi&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">5</span>
                     <span class="p">}</span>
    
    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">mtch</span> <span class="o">=</span> <span class="n">_UNITS_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mtch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%s</span><span class="s2">&#39; as a quota size&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mtch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">*=</span> <span class="n">_UNITS_SCALES</span><span class="p">[</span><span class="n">mtch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This function is used to fork the current process into a daemon.</span>
<span class="sd">Almost none of this is necessary (or advisable) if your daemon</span>
<span class="sd">is being started by inetd. In that case, stdin, stdout and stderr are</span>
<span class="sd">all set up for you to refer to the network connection, and the fork()s</span>
<span class="sd">and session manipulation should not be done (to avoid confusing inetd).</span>
<span class="sd">Only the chdir() and umask() steps remain as useful.</span>

<span class="sd">From:</span>
<span class="sd">http://code.activestate.com/recipes/66012-fork-a-daemon-process-on-unix/</span>

<span class="sd">References:</span>
<span class="sd">UNIX Programming FAQ</span>
<span class="sd">    1.7 How do I get my program to act like a daemon?</span>
<span class="sd">        http://www.erlenstar.demon.co.uk/unix/faq_2.html#SEC16</span>
<span class="sd">        </span>
<span class="sd">    Advanced Programming in the Unix Environment</span>
<span class="sd">    W. Richard Stevens, 1992, Addison-Wesley, ISBN 0-201-56317-7.</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="daemonize"><a class="viewcode-back" href="../../index.html#mnc.common.daemonize">[docs]</a><span class="k">def</span> <span class="nf">daemonize</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This forks the current process into a daemon.</span>
<span class="sd">    The stdin, stdout, and stderr arguments are file names that</span>
<span class="sd">    will be opened and be used to replace the standard file descriptors</span>
<span class="sd">    in sys.stdin, sys.stdout, and sys.stderr.</span>
<span class="sd">    These arguments are optional and default to /dev/null.</span>
<span class="sd">    Note that stderr is opened unbuffered, so</span>
<span class="sd">    if it shares a file with stdout then interleaved output</span>
<span class="sd">    may not appear in the order that you expect.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Do first fork.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Exit first parent.</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fork #1 failed: (</span><span class="si">%d</span><span class="s2">) </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="c1"># Decouple from parent environment.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>
    
    <span class="c1"># Do second fork.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Exit second parent.</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fork #2 failed: (</span><span class="si">%d</span><span class="s2">) </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="c1"># Now I am a daemon!</span>
    
    <span class="c1"># Redirect standard file descriptors.</span>
    <span class="n">si</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span></div>


<div class="viewcode-block" id="LogFileHandler"><a class="viewcode-back" href="../../index.html#mnc.common.LogFileHandler">[docs]</a><span class="k">class</span> <span class="nc">LogFileHandler</span><span class="p">(</span><span class="n">TimedRotatingFileHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sub-class of TimedRotatingFileHandler that rolls over files daily and keeps</span>
<span class="sd">    the last 21 days.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rollover_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">days_per_file</span> <span class="o">=</span>  <span class="mi">1</span>
        <span class="n">file_count</span>    <span class="o">=</span> <span class="mi">21</span>
        <span class="n">TimedRotatingFileHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span>
                                          <span class="n">interval</span><span class="o">=</span><span class="n">days_per_file</span><span class="p">,</span>
                                          <span class="n">backupCount</span><span class="o">=</span><span class="n">file_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollover_callback</span> <span class="o">=</span> <span class="n">rollover_callback</span>
<div class="viewcode-block" id="LogFileHandler.doRollover"><a class="viewcode-back" href="../../index.html#mnc.common.LogFileHandler.doRollover">[docs]</a>    <span class="k">def</span> <span class="nf">doRollover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LogFileHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">doRollover</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollover_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rollover_callback</span><span class="p">()</span></div></div>


<span class="k">def</span> <span class="nf">_handle_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;__main__&quot;</span><span class="p">)</span>
    <span class="n">SIGNAL_NAMES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> \
                            <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SIG&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SIG_&#39;</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received signal </span><span class="si">%i</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">SIGNAL_NAMES</span><span class="p">[</span><span class="n">signum</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="setup_signal_handling"><a class="viewcode-back" href="../../index.html#mnc.common.setup_signal_handling">[docs]</a><span class="k">def</span> <span class="nf">setup_signal_handling</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span>
                                                      <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span>
                                                      <span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">,</span>
                                                      <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span>
                                                      <span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup signal handling for a Bifrost pipeline given a list of block threads.</span>
<span class="sd">    This catches a collection of signals and then calls the `shutdown` method of</span>
<span class="sd">    the first thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">_handle_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">shutdown_event</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shutdown_event</span></div>


<div class="viewcode-block" id="synchronize_time"><a class="viewcode-back" href="../../index.html#mnc.common.synchronize_time">[docs]</a><span class="k">def</span> <span class="nf">synchronize_time</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s1">&#39;ntp.ubuntu.com&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call `ntpdate` with the specified NTP server to update the system time.  Returns</span>
<span class="sd">    a Boolean of whether or not the operation was successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;ntpdate&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">sucess</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">mnc_python</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Casey Law.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>